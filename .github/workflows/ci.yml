name: NextFlix CI Pipeline

on:
  push:
    branches: [ dev ]
  pull_request:
    branches: [ dev ]

jobs:
  # ==================== Backend Tests ====================
  backend-tests:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.9', '3.10', '3.11']
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-cov flask flask-cors requests
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
      
      - name: Run unit tests
        working-directory: backend/flask
        run: |
          pytest test_server.py -v --tb=short
      
      - name: Run integration tests
        working-directory: backend/flask
        run: |
          pytest test_integration.py -v --tb=short
      
      - name: Generate coverage report
        working-directory: backend/flask
        run: |
          pytest test_server.py test_integration.py --cov=. --cov-report=xml --cov-report=html
      
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          files: ./backend/flask/coverage.xml
          flags: backend
          name: backend-coverage
          fail_ci_if_error: false

  # ==================== Frontend Tests ====================
  frontend-tests:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: ['16', '18', '20']
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Set up Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v3
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'
          cache-dependency-path: 'frontend/package.json'
      
      - name: Install dependencies
        working-directory: frontend
        run: npm install
      
      - name: Run linter (ESLint)
        working-directory: frontend
        run: npm run lint --if-present || echo "No lint script defined"
      
      - name: Build React app
        working-directory: frontend
        env:
          CI: 'false'
        run: npm run build
      
      - name: Run tests
        working-directory: frontend
        run: npm test -- --coverage --watchAll=false || echo "No tests defined"

  # ==================== Code Quality & Security ====================
  code-quality:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Install linting tools
        run: |
          python -m pip install flake8 pylint
      
      - name: Lint backend code with flake8
        working-directory: backend/flask
        run: |
          flake8 server.py admin.py --count --select=E9,F63,F7,F82 --show-source --statistics || true
      
      - name: Check code style with pylint
        working-directory: backend/flask
        run: |
          pylint server.py admin.py --disable=all --enable=E,F || true

  # ==================== Database Migration Tests ====================
  database-tests:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install flask
      
      - name: Test database initialization
        working-directory: backend/flask
        run: |
          python -c "
          import sqlite3
          import tempfile
          import os
          from server import app, init_db_schema
          
          # Create temp DB
          fd, path = tempfile.mkstemp(suffix='.db')
          
          with app.app_context():
              # Override DATABASE path
              import server as server_module
              server_module.DATABASE = path
              init_db_schema()
              print('✓ Database schema initialized successfully')
          
          # Verify tables exist
          conn = sqlite3.connect(path)
          cursor = conn.cursor()
          cursor.execute(\"SELECT name FROM sqlite_master WHERE type='table'\")
          tables = cursor.fetchall()
          print(f'✓ Created {len(tables)} tables')
          conn.close()
          os.close(fd)
          os.unlink(path)
          "

  # ==================== Build Status Check ====================
  build-status:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Check project structure
        run: |
          echo "Verifying project structure..."
          [ -d "backend/flask" ] && echo "✓ Backend directory exists"
          [ -d "frontend/src" ] && echo "✓ Frontend directory exists"
          [ -f "requirements.txt" ] && echo "✓ requirements.txt exists"
          [ -f "backend/flask/server.py" ] && echo "✓ server.py exists"
          [ -f "frontend/package.json" ] && echo "✓ package.json exists"
          echo "Build verification complete"

  # ==================== Dependency Check ====================
  dependency-check:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Check Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pip-audit || true
          pip-audit --desc || true

  # ==================== Test Results Summary ====================
  test-summary:
    needs: [backend-tests, frontend-tests, code-quality, database-tests]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: Determine CI status
        run: |
          if [[ "${{ needs.backend-tests.result }}" == "failure" || \
                "${{ needs.frontend-tests.result }}" == "failure" || \
                "${{ needs.code-quality.result }}" == "failure" || \
                "${{ needs.database-tests.result }}" == "failure" ]]; then
            echo "❌ CI Pipeline Failed"
            exit 1
          else
            echo "✅ CI Pipeline Passed"
          fi
      
      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v6
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '✅ All CI checks passed! Ready for review.'
            })
